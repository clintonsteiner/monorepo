name: Weekly Release

on:
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: "0 0 * * 1"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  packages: write

jobs:
  test:
    name: Test Before Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history for version calculation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Initialize Pants
        uses: pantsbuild/actions/init-pants@main
        with:
          pants-python-version: "3.11"
          gha-cache-key: v1
          named-caches-hash: ${{ hashFiles('pants.toml') }}

      - name: Run all checks
        run: |
          pants tailor --check ::
          pants update-build-files --check ::
          pants lint ::
          pants fmt --check ::
          pants test ::
          echo "âœ“ All checks passed"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: test
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_created: ${{ steps.version.outputs.release_created }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Get current version and calculate next
        id: version
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "release_created=true" >> $GITHUB_OUTPUT

      - name: Update pyproject.toml version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          VERSION_NO_V=${VERSION#v}
          sed -i "s/^version = \".*\"/version = \"$VERSION_NO_V\"/" pyproject.toml
          cat pyproject.toml | grep "^version"

      - name: Initialize Pants
        uses: pantsbuild/actions/init-pants@main
        with:
          pants-python-version: "3.11"
          gha-cache-key: v1
          named-caches-hash: ${{ hashFiles('pants.toml') }}

      - name: Build PEX files
        run: |
          pants package ::
          ls -lh dist/*.pex

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build images with Pants
        run: pants package //ercot_lmp:docker //db_setup:docker

      - name: Tag and push
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Tag ercot-lmp
          docker tag ercot-lmp:latest ghcr.io/${{ github.repository_owner }}/ercot-lmp:latest
          docker tag ercot-lmp:latest ghcr.io/${{ github.repository_owner }}/ercot-lmp:$VERSION
          docker push ghcr.io/${{ github.repository_owner }}/ercot-lmp:latest
          docker push ghcr.io/${{ github.repository_owner }}/ercot-lmp:$VERSION

          # Tag ercot-db
          docker tag ercot-db:latest ghcr.io/${{ github.repository_owner }}/ercot-db:latest
          docker tag ercot-db:latest ghcr.io/${{ github.repository_owner }}/ercot-db:$VERSION
          docker push ghcr.io/${{ github.repository_owner }}/ercot-db:latest
          docker push ghcr.io/${{ github.repository_owner }}/ercot-db:$VERSION

      - name: Create release notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > release-notes.md << EOF
          # Release $VERSION

          ## ðŸš€ What's Included

          ### PEX Executables
          - \`ercot_lmp.pex\` - Main application ($(ls -lh dist/ercot_lmp.pex | awk '{print $5}'))
          - \`hello_world.pex\` - Hello world CLI tool ($(ls -lh dist/hello_world.pex | awk '{print $5}'))

          ### Docker Images
          - \`ercot-lmp:${VERSION}\` - Application container
          - \`ercot-db:${VERSION}\` - PostgreSQL database container

          ## ðŸ“¦ Installation

          ### Using PEX Files
          \`\`\`bash
          # Download PEX file
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/ercot_lmp.pex
          chmod +x ercot_lmp.pex
          ./ercot_lmp.pex
          \`\`\`

          ### Using Docker
          \`\`\`bash
          # Run application
          docker run --rm ${{ secrets.DOCKER_USERNAME }}/ercot-lmp:${VERSION}

          # Run database
          docker run -d -p 5432:5432 \\
            -e POSTGRES_USER=ercot_user \\
            -e POSTGRES_PASSWORD=ercot_pass \\
            -e POSTGRES_DB=ercot_db \\
            ${{ secrets.DOCKER_USERNAME }}/ercot-db:${VERSION}
          \`\`\`

          ## âœ… Quality Checks

          - âœ“ All tests passed
          - âœ“ Code formatting validated
          - âœ“ Linting checks passed
          - âœ“ BUILD files validated

          ## ðŸ“ Changes

          This is an automated weekly release.

          View the full changelog: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^)...${VERSION}
          EOF

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git tag ${{ steps.version.outputs.version }}
          git push origin HEAD:${{ github.ref_name }} --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            dist/*.pex
          draft: false
          prerelease: false

      - name: Create release summary
        run: |
          echo "## ðŸŽ‰ Release ${{ steps.version.outputs.version }} Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- PEX files uploaded to release" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images pushed to registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
