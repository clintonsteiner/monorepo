name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  test:
    name: Test and Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Initialize Pants
        uses: pantsbuild/actions/init-pants@main
        with:
          pants-python-version: '3.11'
          gha-cache-key: v1
          named-caches-hash: ${{ hashFiles('pants.toml') }}

      - name: Check BUILD files are up to date
        run: |
          pants tailor --check ::
          echo "✓ BUILD files are up to date"

      - name: Check BUILD file formatting
        run: |
          pants update-build-files --check ::
          echo "✓ BUILD files are properly formatted"

      - name: Lint code
        run: |
          pants lint ::
          echo "✓ Linting passed"

      - name: Check formatting
        run: |
          pants fmt --check ::
          echo "✓ Code formatting is correct"

      - name: Run tests
        run: |
          pants test ::
          echo "✓ All tests passed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: .pants.d/test/reports/

  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Initialize Pants
        uses: pantsbuild/actions/init-pants@main
        with:
          pants-python-version: '3.11'
          gha-cache-key: v1
          named-caches-hash: ${{ hashFiles('pants.toml') }}

      - name: Build PEX files
        run: |
          pants package ::
          ls -lh dist/*.pex
          echo "✓ PEX files built successfully"

      - name: Upload PEX artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pex-files
          path: dist/*.pex
          retention-days: 30

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (no push)
        run: |
          docker build -t ercot-lmp:ci .
          docker build -f db_setup/Dockerfile.db -t ercot-db:ci db_setup/
          echo "✓ Docker images built successfully"

      - name: Test Docker images
        run: |
          # Test hello_world.pex in Docker
          docker run --rm --entrypoint /app/bin/hello_world.pex ercot-lmp:ci --name "CI"
          echo "✓ Docker container test passed"
